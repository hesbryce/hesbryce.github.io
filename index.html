<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZBE</title>
  <link rel="stylesheet" href="home.css" />
</head>

<body>
  <nav class="navbar">
    <div class="nav-content">
      <h1 class="name">IRL Health Bar</h1>
      <p class="title">Membership Version: Premium Trial</p>
    </div>
  </nav>
  <header class="hero">
    <h1>Your Health Bar, Everywhere You Go.</h1>
    <p>From workouts to telehealth, see your body's energy at a glance.</p>
    <p>Start your health journey today.</p>
  </header>
  <section class="about">
  </section>

  <section class="stamina-showcase">
    <div class="showcase-card">
      <div class="card-header">
        <h2>Health Bar</h2>
        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span class="status-text" id="status">Loading...</span>
        </div>
      </div>

      <div class="stamina-display">
        <div class="stamina-container" id="stamina-container">
          <div class="loading-label" id="loading-label">Loading...</div>
          <div class="stamina-bar-wrapper">
            <div class="stamina-bar loading-bar" id="stamina-bar">
              <div class="shimmer-overlay" id="shimmer"></div>
              <div class="fill-bar" id="fill-bar">
                <div class="highlight-shine"></div>
              </div>
            </div>
            <div class="percentage-text" id="percentage-text">
              <span class="percentage-number" id="score">--</span>
              <span class="percentage-symbol">%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    let isLoading = true;
    let shimmerX = -120;
    let shimmerInterval = null;

    function startShimmer() {
      if (shimmerInterval) return;
      shimmerInterval = setInterval(() => {
        if (isLoading) {
          shimmerX += 2;
          if (shimmerX >= 120) shimmerX = -120;
          const shimmerEl = document.getElementById('shimmer');
          if (shimmerEl) {
            shimmerEl.style.transform = `translateX(${shimmerX}%)`;
          }
        }
      }, 50);
    }

    function stopShimmer() {
      if (shimmerInterval) {
        clearInterval(shimmerInterval);
        shimmerInterval = null;
      }
    }

    function startPulse() {
      if (isLoading) return;
      const fillBar = document.getElementById('fill-bar');
      if (fillBar) {
        fillBar.classList.add('pulse');
      }
    }

    startShimmer();

    function parseTimestamp(timestampStr) {
      if (!timestampStr || timestampStr === '--') return null;
      
      const match = timestampStr.match(/(\d{1,2}):(\d{2}):(\d{2})\s?(AM|PM)\s?CST/i);
      if (!match) return null;
      
      const [, hours, minutes, seconds, ampm] = match;
      const now = new Date();
      const timestamp = new Date();
      
      let hour24 = parseInt(hours);
      if (ampm.toUpperCase() === 'PM' && hour24 !== 12) {
        hour24 += 12;
      } else if (ampm.toUpperCase() === 'AM' && hour24 === 12) {
        hour24 = 0;
      }
      
      timestamp.setHours(hour24);
      timestamp.setMinutes(parseInt(minutes));
      timestamp.setSeconds(parseInt(seconds));
      timestamp.setMilliseconds(0);
      
      if (timestamp > now) {
        timestamp.setDate(timestamp.getDate() - 1);
      }
      
      return timestamp;
    }

    function isDataStale(timestamp) {
      if (!timestamp) return false;
      
      const dataTime = parseTimestamp(timestamp);
      if (!dataTime) return false;
      
      const now = new Date();
      const minutesSinceUpdate = (now - dataTime) / (1000 * 60);
      
      return minutesSinceUpdate > 2;
    }

    function getGradientColors(percentage) {
      if (percentage >= 91) return ['#007AFF80', '#007AFF'];
      if (percentage >= 86) return ['#34C75980', '#34C759'];
      if (percentage >= 76) return ['#FFCC02', '#34C759'];
      if (percentage >= 51) return ['#FFCC02', '#FFCC02'];
      if (percentage >= 40) return ['#FFCC02', '#FF9500'];
      if (percentage >= 30) return ['#FF950080', '#FF9500'];
      return ['#FF384580', '#FF3B30'];
    }

    function getBodyGradientColors(percentage) {
      if (percentage >= 91) return ['#4A90E2', '#667eea']; // Blue theme
      if (percentage >= 86) return ['#32A852', '#4CAF50']; // Green theme
      if (percentage >= 76) return ['#7ED321', '#8BC34A']; // Yellow-Green theme
      if (percentage >= 51) return ['#F5A623', '#FF9800']; // Yellow theme
      if (percentage >= 40) return ['#FF8C00', '#FF6347']; // Orange theme
      if (percentage >= 30) return ['#FF6347', '#FF4500']; // Orange-Red theme
      return ['#D0021B', '#8B0000']; // Red theme
    }

    function updateBodyGradient(percentage) {
      const bodyColors = getBodyGradientColors(percentage);
      document.body.style.background = `linear-gradient(135deg, ${bodyColors[0]} 0%, ${bodyColors[1]} 100%)`;
    }

    function updateStaminaBar(percentage) {
      const minFillFraction = 0.2;
      const displayFrac = Math.max(Math.min(percentage / 100, 1), minFillFraction);
      const colors = getGradientColors(percentage);
      const fillBar = document.getElementById('fill-bar');
      const staminaBar = document.getElementById('stamina-bar');
      const loadingLabel = document.getElementById('loading-label');

      if (isLoading) {
        isLoading = false;
        stopShimmer();

        setTimeout(() => {
          staminaBar.classList.remove('loading-bar');
          staminaBar.classList.add('background-bar');
          loadingLabel.style.opacity = '0';
          document.getElementById('shimmer').style.opacity = '0';

          setTimeout(() => {
            loadingLabel.style.display = 'none';
            document.getElementById('shimmer').style.display = 'none';
            startPulse();
          }, 300);
        }, 100);
      }

      requestAnimationFrame(() => {
        fillBar.style.width = `${displayFrac * 100}%`;
        fillBar.style.background = `linear-gradient(90deg, ${colors[0]}, ${colors[1]})`;
        updateBodyGradient(percentage);
      });
    }

    function updateStatus(status) {
      const statusElement = document.getElementById('status');
      const statusDot = document.getElementById('status-dot');

      if (statusElement.textContent !== status) {
        statusElement.textContent = status;
      }

      let color = '#8E8E93';
      if (status === 'Connected') color = '#34C759';
      else if (status === 'Loading...') color = '#FFCC02';
      else if (status === 'App disconnected') color = '#FF9500';
      else if (status === 'Session Ended') color = '#FF3B30';
      else if (status === 'No data available') color = '#8E8E93';

      statusDot.style.backgroundColor = color;
    }

    async function fetchLatest() {
      try {
        const res = await fetch("https://stamina-api.onrender.com/latest", { 
          cache: "no-store",
          headers: {
            "Authorization": "Bearer 64fb6211443467e8666fc9c532cdd6ae82058bde862005f338900b90e40ab546"
          }
        });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const d = await res.json();

        if (d.message) {
          updateStatus('No data available');
          document.getElementById("score").textContent = "--";
        } else {
          if (isDataStale(d.timestamp)) {
            updateStatus('App disconnected');
          } else {
            updateStatus('Connected');
          }
          
          document.getElementById("score").textContent = d.staminaScore ?? "--";
          updateStaminaBar(parseInt(d.staminaScore) || 0);
        }
      } catch (err) {
        updateStatus('Session Ended');
        console.error(err);
      }
    }

    fetchLatest();
    setInterval(fetchLatest, 5000);
  </script>
</body>

</html>