<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IRL Health Bar Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      overflow: hidden;
    }

    .widget-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .widget-title {
      font-size: 14px;
      font-weight: 600;
      opacity: 0.9;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      opacity: 0.8;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #8E8E93;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .score-display {
      text-align: center;
      margin: 15px 0;
    }

    .score-number {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .score-label {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 5px;
    }

    .bar-container {
      width: 100%;
      height: 24px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin: 15px 0;
    }

    .bar-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.4s ease;
      min-width: 20%;
      position: relative;
      overflow: hidden;
    }

    .bar-shine {
      position: absolute;
      top: -50%;
      right: 20%;
      width: 30%;
      height: 30%;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 12px;
    }

    .widget-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      opacity: 0.7;
    }

    .last-update {
      font-size: 10px;
    }

    .error-state {
      text-align: center;
      padding: 20px;
    }

    .error-message {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.9;
    }

    .powered-by {
      font-size: 9px;
      opacity: 0.6;
    }

    .loading-shimmer {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.15), 
        transparent
      );
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
  </style>
</head>
<body>
  <div class="widget-container" id="widget">
    <div class="widget-header">
      <div class="widget-title">Health Bar</div>
      <div class="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Loading...</span>
      </div>
    </div>

    <div class="score-display">
      <div class="score-number" id="score">--</div>
      <div class="score-label">Energy Level</div>
    </div>

    <div class="bar-container">
      <div class="bar-fill" id="bar-fill">
        <div class="bar-shine"></div>
      </div>
    </div>

    <div class="widget-footer">
      <div class="last-update" id="last-update">Never updated</div>
      <div class="powered-by">IRL Health Bar</div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const friendlyId = params.get('id');
    const refreshInterval = 900000; // 15 minutes in milliseconds
    let fetchTimeout = null;

    function getGradientColors(percentage) {
      if (percentage >= 91) return ['#007AFF80', '#007AFF'];
      if (percentage >= 86) return ['#34C75980', '#34C759'];
      if (percentage >= 76) return ['#FFCC02', '#34C759'];
      if (percentage >= 51) return ['#FFCC02', '#FFCC02'];
      if (percentage >= 40) return ['#FFCC02', '#FF9500'];
      if (percentage >= 30) return ['#FF950080', '#FF9500'];
      return ['#FF384580', '#FF3B30'];
    }

    function updateStatus(status, color) {
      const statusText = document.getElementById('status-text');
      const statusDot = document.getElementById('status-dot');
      
      statusText.textContent = status;
      statusDot.style.backgroundColor = color;
    }

    function updateBar(percentage) {
      const barFill = document.getElementById('bar-fill');
      const displayPercentage = Math.max(Math.min(percentage, 100), 20);
      const colors = getGradientColors(percentage);
      
      barFill.style.width = `${displayPercentage}%`;
      barFill.style.background = `linear-gradient(90deg, ${colors[0]}, ${colors[1]})`;
    }

    function showError(message) {
      const widget = document.getElementById('widget');
      widget.innerHTML = `
        <div class="error-state">
          <div class="score-number">⚠️</div>
          <div class="error-message">${message}</div>
          <div class="powered-by" style="margin-top: 20px; opacity: 0.6;">IRL Health Bar</div>
        </div>
      `;
    }

    async function fetchHealthData() {
      if (!friendlyId) {
        showError('No ID provided. Add ?id=YOUR_CODE to the URL.');
        return;
      }

      try {
        updateStatus('Updating...', '#FFCC02');

        const response = await fetch(
          `https://stamina-api.onrender.com/resolve-friendly-id/${friendlyId}`,
          { cache: 'no-store' }
        );

        if (response.status === 404) {
          showError('ID not found. Please check your Web ID.');
          return;
        }

        if (response.status === 410) {
          showError('ID expired. Generate a new one in the app.');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data.stamina_data) {
          updateStatus('No data yet', '#8E8E93');
          document.getElementById('score').textContent = '--';
          document.getElementById('last-update').textContent = 'Waiting for data...';
          return;
        }

        const staminaScore = data.stamina_data.staminaScore;
        const timestamp = data.stamina_data.timestamp;

        document.getElementById('score').textContent = staminaScore;
        updateBar(parseInt(staminaScore));
        updateStatus('Connected', '#34C759');
        document.getElementById('last-update').textContent = `Updated ${timestamp}`;

        // Schedule next update
        if (fetchTimeout) clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(fetchHealthData, refreshInterval);

      } catch (error) {
        console.error('Widget fetch error:', error);
        updateStatus('Error', '#FF3B30');
        document.getElementById('last-update').textContent = 'Connection failed';
        
        // Retry in 1 minute on error
        if (fetchTimeout) clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(fetchHealthData, 60000);
      }
    }

    // Start fetching data
    fetchHealthData();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (fetchTimeout) clearTimeout(fetchTimeout);
    });
  </script>
</body>
</html>